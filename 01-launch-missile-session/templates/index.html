<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Launch Missile Session</title>
        <style>
            main {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            form {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            label {
                display: flex;
                justify-content: space-around;
                gap: 1rem;
            }
        </style>
    </head>
    <body>
        <main>
            <!-- Login accordion -->
            <details>
                <summary>Login</summary>
                <form>
                    <label>
                        Email:
                        <input type="email" id="email" value="vidu@example.com" />
                    </label>

                    <label>
                        Password:
                        <input type="password" id="password" value="fish" />
                    </label>

                    <button>Login</button>
                </form>
            </details>

            <div id="auth-result">not logged in</div>

            <button onclick="launch()">Launch missile</button>

            <div id="launch-result">...</div>
        </main>

        <script>
            let sessionId = localStorage.getItem('sessionId');
            let token = localStorage.getItem('token');

            if (sessionId && token) {
                document.querySelector('#auth-result').textContent = 'already logged in';
            }

            document.querySelector('form').addEventListener('submit', handleLogin);

            async function handleLogin(event) {
                event.preventDefault();

                const response = await fetch('http://127.0.0.1:5000/auth/login', {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: document.querySelector('#email').value,
                        password: document.querySelector('#password').value,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    console.log(data);
                    sessionId = data.payload.sessionId;
                    token = data.payload.token;
                    localStorage.setItem('sessionId', sessionId);
                    localStorage.setItem('token', token);
                } else {
                    console.error(data);
                }
                document.querySelector('#auth-result').textContent = data.message;
            }

            async function launch() {
                const response = await fetch(
                    `http://127.0.0.1:5000/launch-missile?session_id=${sessionId}&token=${token}`
                );

                const data = await response.json();

                if (data.success) {
                    console.log(data);
                } else {
                    console.error(data);
                }
                document.querySelector('#launch-result').textContent = data.message;
            }
        </script>
    </body>
</html>
